name: Deploy Airflow

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Definir KUBECONFIG
        run: echo "KUBECONFIG=/home/master/.kube/config" >> $GITHUB_ENV

      - name: Adicionar repositório Helm do Apache Airflow
        run: |
          helm repo add apache-airflow https://airflow.apache.org || true
          helm repo update

      - name: Verificar conteúdo do values.yaml (debug)
        run: |
          echo "==> Verificando ./helm/airflow/values.yaml"
          test -f ./helm/airflow/values.yaml && cat ./helm/airflow/values.yaml || (echo "Arquivo não encontrado!" && exit 1)

      - name: Executar Helm upgrade (ou fallback para instalação limpa)
        run: |
          set -e
          echo "▶ Tentando upgrade..."
          if ! helm upgrade --install airflow apache-airflow/airflow \
            --version 1.13.0 \
            --namespace airflow \
            --create-namespace \
            -f ./helm/airflow/values.yaml \
            --kube-insecure-skip-tls-verify; then
              echo "⚠️ Helm upgrade falhou. Recriando..."
              helm uninstall airflow -n airflow || true
              kubectl delete pvc -l release=airflow -n airflow --insecure-skip-tls-verify || true
              helm install airflow apache-airflow/airflow \
                --version 1.13.0 \
                --namespace airflow \
                --create-namespace \
                -f ./helm/airflow/values.yaml \
                --kube-insecure-skip-tls-verify
          fi

      - name: Verificar status dos pods
        run: |
          kubectl get pods -n airflow -o wide --insecure-skip-tls-verify
