name: Deploy Airflow

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set KUBECONFIG
        run: echo "KUBECONFIG=/home/master/.kube/config" >> $GITHUB_ENV

      - name: Set Helm context
        run: |
          kubectl config use-context airflow

      - name: Add Apache Airflow Helm repo
        run: |
          helm repo add apache-airflow https://airflow.apache.org
          helm repo update

      - name: Try Helm upgrade (or fallback to clean install)
        run: |
          set -e
          echo "▶ Tentando upgrade..."
          if ! helm upgrade --install airflow apache-airflow/airflow \
            --namespace airflow \
            --create-namespace \
            -f ./helm/airflow/values.yaml; then
              echo "⚠️ Helm upgrade falhou. Recriando..."
              helm uninstall airflow -n airflow || true
              kubectl delete pvc -l release=airflow -n airflow || true
              helm install airflow apache-airflow/airflow \
                --namespace airflow \
                --create-namespace \
                -f ./helm/airflow/values.yaml
          fi

      - name: Verificar pods
        run: |
          kubectl get pods -n airflow
